/**
 * Automatically generated by Zserio C++ extension version 1.4.0-pre2.
 */

#include "zserio/BitStreamWriter.h"
#include "zserio/BitStreamReader.h"
#include "zserio/StringConvertUtil.h"

#include "zserio_runtime/PubSubException.h"

#include "Client.h"

namespace pubsub_poc
{

Client::Client(::zserio::IPubSubClient& pubSubClient) : m_pubSubClient(pubSubClient)
{
}

void Client::publishRequest(::pubsub_poc::Int32Value& object, void* context) const
{
    publishZserioObject(object, "pubsub/request", context);
}

::zserio::IPubSubClient::SubscriptionId Client::subscribePowerOfTwo(
        const std::function<void(const std::string& topic, const ::pubsub_poc::UInt64Value& object)>& callback,
        void* context)
{
    const ::zserio::IPubSubClient::OnTopic rawCallback = std::bind(&Client::onRawUInt64Value, this,
            std::placeholders::_1, std::placeholders::_2, std::placeholders::_3);
    const std::string topic("pubsub/powerOfTwo");
    const ::zserio::IPubSubClient::SubscriptionId id =
            m_pubSubClient.subscribe(topic, rawCallback, context);

    const auto result = m_subscribersUInt64Value.emplace(id, callback);
    if (!result.second)
        throw ::zserio::PubSubException("pubsub_poc.Client: Topic '" + topic + "' already subscribed!");

    return id;
}

void Client::unsubscribePowerOfTwo(zserio::IPubSubClient::SubscriptionId id)
{
    const auto foundSubscriber = m_subscribersUInt64Value.find(id);
    if (foundSubscriber == m_subscribersUInt64Value.end())
        throw ::zserio::PubSubException("pubsub_poc.Client: Unknown subscription id '" +
                ::zserio::convertToString(id) + "' for 'UInt64Value' !");

    m_pubSubClient.unsubscribe(id);
    m_subscribersUInt64Value.erase(foundSubscriber);
}

::zserio::IPubSubClient::SubscriptionId Client::subscribeBooleanResponse(
        const std::function<void(const std::string& topic, const ::pubsub_poc::BoolValue& object)>& callback,
        void* context)
{
    const ::zserio::IPubSubClient::OnTopic rawCallback = std::bind(&Client::onRawBoolValue, this,
            std::placeholders::_1, std::placeholders::_2, std::placeholders::_3);
    const std::string topic("pubsub/boolean/#");
    const ::zserio::IPubSubClient::SubscriptionId id =
            m_pubSubClient.subscribe(topic, rawCallback, context);

    const auto result = m_subscribersBoolValue.emplace(id, callback);
    if (!result.second)
        throw ::zserio::PubSubException("pubsub_poc.Client: Topic '" + topic + "' already subscribed!");

    return id;
}

void Client::unsubscribeBooleanResponse(zserio::IPubSubClient::SubscriptionId id)
{
    const auto foundSubscriber = m_subscribersBoolValue.find(id);
    if (foundSubscriber == m_subscribersBoolValue.end())
        throw ::zserio::PubSubException("pubsub_poc.Client: Unknown subscription id '" +
                ::zserio::convertToString(id) + "' for 'BoolValue' !");

    m_pubSubClient.unsubscribe(id);
    m_subscribersBoolValue.erase(foundSubscriber);
}

void Client::onRawUInt64Value(zserio::IPubSubClient::SubscriptionId id, const std::string& topic,
        const std::vector<uint8_t>& data) const
{
    ::zserio::BitStreamReader reader(data.data(), data.size());
    const UInt64Value object(reader);

    const auto foundSubscriber = m_subscribersUInt64Value.find(id);
    if (foundSubscriber == m_subscribersUInt64Value.end())
    {
        throw ::zserio::PubSubException("pubsub_poc.Client: Unknown subscription id '" +
                ::zserio::convertToString(id) + "' for 'UInt64Value' !");
    }
    foundSubscriber->second(topic, object);
}

void Client::onRawBoolValue(zserio::IPubSubClient::SubscriptionId id, const std::string& topic,
        const std::vector<uint8_t>& data) const
{
    ::zserio::BitStreamReader reader(data.data(), data.size());
    const BoolValue object(reader);

    const auto foundSubscriber = m_subscribersBoolValue.find(id);
    if (foundSubscriber == m_subscribersBoolValue.end())
    {
        throw ::zserio::PubSubException("pubsub_poc.Client: Unknown subscription id '" +
                ::zserio::convertToString(id) + "' for 'BoolValue' !");
    }
    foundSubscriber->second(topic, object);
}

template<typename ZSERIO_OBJECT>
void Client::publishZserioObject(ZSERIO_OBJECT& object, const std::string& topic,
        void* context) const
{
    std::vector<uint8_t> data(object.bitSizeOf() + 7 / 8);
    ::zserio::BitStreamWriter writer(data.data(), data.size());
    object.write(writer);
    m_pubSubClient.publish(topic, data, context);
}

} // namespace pubsub_poc
