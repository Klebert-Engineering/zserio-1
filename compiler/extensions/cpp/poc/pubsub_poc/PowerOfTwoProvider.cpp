/**
 * Automatically generated by Zserio C++ extension version 1.4.0-pre2.
 */

#include "zserio/BitStreamWriter.h"
#include "zserio/BitStreamReader.h"
#include "zserio/StringConvertUtil.h"

#include "zserio_runtime/PubSubException.h"

#include "PowerOfTwoProvider.h"

namespace pubsub_poc
{

PowerOfTwoProvider::PowerOfTwoProvider(::zserio::IPubSubClient& pubSubClient) : m_pubSubClient(pubSubClient)
{
}

void PowerOfTwoProvider::publishPowerOfTwo(::pubsub_poc::UInt64Value& object, void* context) const
{
    publishZserioObject(object, "pubsub/powerOfTwo", context);
}

::zserio::IPubSubClient::SubscriptionId PowerOfTwoProvider::subscribeRequest(
        const std::function<void(const std::string& topic, const ::pubsub_poc::Int32Value& object)>& callback,
        void* context)
{
    const ::zserio::IPubSubClient::OnTopic rawCallback = std::bind(&PowerOfTwoProvider::onRawInt32Value, this,
            std::placeholders::_1, std::placeholders::_2, std::placeholders::_3);
    const std::string topic("pubsub/request");
    const ::zserio::IPubSubClient::SubscriptionId id = m_pubSubClient.subscribe(topic, rawCallback, context);

    const auto result = m_subscribersInt32Value.emplace(id, callback);
    if (!result.second)
    {
        throw ::zserio::PubSubException("pubsub_poc.PowerOfTwoProvider: Topic '" + topic +
                "' already subscribed!");
    }

    return id;
}

void PowerOfTwoProvider::unsubscribeRequest(zserio::IPubSubClient::SubscriptionId id)
{
    const auto foundSubscriber = m_subscribersInt32Value.find(id);
    if (foundSubscriber == m_subscribersInt32Value.end())
        throw ::zserio::PubSubException("pubsub_poc.PowerOfTwoProvider: Unknown subscription id '" +
                ::zserio::convertToString(id) + "' for 'Int32Value' !");

    m_pubSubClient.unsubscribe(id);
    m_subscribersInt32Value.erase(foundSubscriber);
}

void PowerOfTwoProvider::onRawInt32Value(zserio::IPubSubClient::SubscriptionId id, const std::string& topic,
        const std::vector<uint8_t>& data) const
{
    ::zserio::BitStreamReader reader(data.data(), data.size());
    const Int32Value object(reader);

    const auto foundSubscriber = m_subscribersInt32Value.find(id);
    if (foundSubscriber == m_subscribersInt32Value.end())
    {
        throw ::zserio::PubSubException("pubsub_poc.PowerOfTwoProvider: Unknown subscription id '" +
                ::zserio::convertToString(id) + "' for 'Int32Value' !");
    }
    foundSubscriber->second(topic, object);
}

template<typename ZSERIO_OBJECT>
void PowerOfTwoProvider::publishZserioObject(ZSERIO_OBJECT& object, const std::string& topic,
        void* context) const
{
    std::vector<uint8_t> data(object.bitSizeOf() + 7 / 8);
    ::zserio::BitStreamWriter writer(data.data(), data.size());
    object.write(writer);
    m_pubSubClient.publish(topic, data, context);
}

} // namespace pubsub_poc
