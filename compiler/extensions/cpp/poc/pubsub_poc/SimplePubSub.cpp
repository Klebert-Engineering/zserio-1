/**
 * Automatically generated by Zserio C++ extension version 1.4.0-pre2.
 */

#include "zserio/BitStreamWriter.h"
#include "zserio/BitStreamReader.h"
#include "zserio/StringConvertUtil.h"

#include "zserio_runtime/PubSubException.h"

#include "SimplePubSub.h"

namespace pubsub_poc
{

SimplePubSub::SimplePubSub(::zserio::IPubSubClient& pubSubClient) : m_pubSubClient(pubSubClient)
{
}

void SimplePubSub::publishUInt64Value(::pubsub_poc::UInt64Value& object, void* context) const
{
    publishZserioObject(object, "pubsub/uint64", context);
}

void SimplePubSub::publishInt32ValueOut(::pubsub_poc::Int32Value& object, void* context) const
{
    publishZserioObject(object, "pubsub/int32", context);
}

::zserio::IPubSubClient::SubscriptionId SimplePubSub::subscribeInt32ValueIn(
        const std::function<void(const std::string& topic, const ::pubsub_poc::Int32Value& object)>& callback,
        void* context)
{
    const ::zserio::IPubSubClient::OnTopic rawCallback = std::bind(&SimplePubSub::onRawInt32ValueIn, this,
            std::placeholders::_1, std::placeholders::_2);
    const std::string topic("pubsub/int32");
    const ::zserio::IPubSubClient::SubscriptionId id =
            m_pubSubClient.subscribe(topic, rawCallback, context);

    const auto result = m_subscribersInt32Value.insert({id, callback});
    if (!result.second)
        throw ::zserio::PubSubException("pubsub_poc.SimplePubSub: Topic '" + topic + "' already subscribed!");

    return id;
}

void SimplePubSub::unsubscribeInt32ValueIn(zserio::IPubSubClient::SubscriptionId id)
{
    const auto foundSubscriber = m_subscribersInt32Value.find(id);
    if (foundSubscriber == m_subscribersInt32Value.end())
        throw ::zserio::PubSubException("pubsub_poc.SimplePubSub: Unknown subscription id '" +
                ::zserio::convertToString(id) + "' for 'Int32Value' !");

    m_pubSubClient.unsubscribe(id);
    m_subscribersInt32Value.erase(foundSubscriber);
}

::zserio::IPubSubClient::SubscriptionId SimplePubSub::subscribeBoolValue(
        const std::function<void(const std::string& topic, const ::pubsub_poc::BoolValue& object)>& callback,
        void* context)
{
    const ::zserio::IPubSubClient::OnTopic rawCallback = std::bind(&SimplePubSub::onRawBoolValue, this,
            std::placeholders::_1, std::placeholders::_2);
    const std::string topic("pubsub/bool");
    const ::zserio::IPubSubClient::SubscriptionId id =
            m_pubSubClient.subscribe(topic, rawCallback, context);

    const auto result = m_subscribersBoolValue.insert({id, callback});
    if (!result.second)
        throw ::zserio::PubSubException("pubsub_poc.SimplePubSub: Topic '" + topic + "' already subscribed!");

    return id;
}

void SimplePubSub::unsubscribeBoolValue(zserio::IPubSubClient::SubscriptionId id)
{
    const auto foundSubscriber = m_subscribersBoolValue.find(id);
    if (foundSubscriber == m_subscribersBoolValue.end())
        throw ::zserio::PubSubException("pubsub_poc.SimplePubSub: Unknown subscription id '" +
                ::zserio::convertToString(id) + "' for 'BoolValue' !");

    m_pubSubClient.unsubscribe(id);
    m_subscribersBoolValue.erase(foundSubscriber);
}

void SimplePubSub::onRawInt32ValueIn(const std::string& topic, const std::vector<uint8_t>& data) const
{
    ::zserio::BitStreamReader reader(data.data(), data.size());
    const Int32Value object(reader);

    for (const auto& subscribers : m_subscribersInt32Value)
        subscribers.second(topic, object);
}

void SimplePubSub::onRawBoolValue(const std::string& topic, const std::vector<uint8_t>& data) const
{
    ::zserio::BitStreamReader reader(data.data(), data.size());
    const BoolValue object(reader);

    for (const auto& subscribers : m_subscribersBoolValue)
        subscribers.second(topic, object);
}

template<typename ZSERIO_OBJECT>
void SimplePubSub::publishZserioObject(ZSERIO_OBJECT& object, const std::string& topic,
        void* context) const
{
    std::vector<uint8_t> data(object.bitSizeOf() + 7 / 8);
    ::zserio::BitStreamWriter writer(data.data(), data.size());
    object.write(writer);
    m_pubSubClient.publish(topic, data, context);
}

} // namespace pubsub_poc
